<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Gunnuu Bakers</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-layout {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: var(--primary);
            color: white;
            padding: 2rem 1.5rem;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .sidebar-logo {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            color: var(--accent);
            margin-bottom: 3rem;
            text-align: center;
        }

        .sidebar-nav a {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            transition: var(--transition);
        }

        .sidebar-nav a.active,
        .sidebar-nav a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar-nav i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            background: #F5F7F9;
            padding: 2rem 3rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info h4 {
            font-family: var(--font-body);
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .stat-info div {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .search-bar {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 300px;
            outline: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            font-weight: 700;
            color: var(--text-light);
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f9f9f9;
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--text-light);
            min-width: 80px;
        }

        .activity-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }
    </style>
</head>

<body>

    <div class="admin-layout">
        <aside class="sidebar" style="background: #2D1A19; color: #f5f5f5;">
            <div class="sidebar-logo"
                style="color: #D4AF37; font-family: 'Playfair Display', serif; border-bottom: 1px solid #444; padding-bottom: 1rem;">
                Gunnuu Admin</div>
            <nav class="sidebar-nav">
                <a href="javascript:void(0)" class="active" onclick="switchTab('analytics', this)"><i
                        class="fas fa-chart-pie"></i> Analytics</a>
                <a href="javascript:void(0)" onclick="switchTab('products', this)"><i class="fas fa-birthday-cake"></i>
                    Manage Catalogue</a>
                <a href="javascript:void(0)" onclick="switchTab('customers', this)"><i class="fas fa-history"></i>
                    Activity Log</a>

                <hr style="border: 0; border-top: 1px solid #444; margin: 1rem 0;">

                <a href="catalogue.html" target="_blank"><i class="fas fa-book-open"></i> View Catalogue</a>
                <a href="index.html" target="_blank"><i class="fas fa-globe"></i> Visit Website</a>

                <a href="javascript:void(0)" onclick="logoutBtn()" style="margin-top: 2rem; color: #ff5252;"><i
                        class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
        </aside>

        <main class="main-content">

            <!-- Tab: Analytics -->
            <section id="tab-analytics" class="tab-content active">
                <div class="header-actions">
                    <h1>Dashboard Overview</h1>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #E3F2FD; color: #1E88E5;"><i class="fas fa-eye"></i>
                        </div>
                        <div class="stat-info">
                            <h4>Total Visits</h4>
                            <div id="stat-visits">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #FFF3E0; color: #FB8C00;"><i
                                class="fas fa-shopping-cart"></i></div>
                        <div class="stat-info">
                            <h4>Total Leads</h4>
                            <div id="stat-leads">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #F3E5F5; color: #8E24AA;"><i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info">
                            <h4>Inventory</h4>
                            <div id="stat-products">0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Recent Site Performance</h3>
                    <p style="color: #757575; margin-bottom: 2rem;">Real-time tracking of user interactions on your
                        website.</p>
                    <div id="analytics-summary">
                        <!-- Summary text built by JS -->
                    </div>
                </div>
            </section>

            <!-- Tab: Products -->
            <section id="tab-products" class="tab-content">
                <div class="header-actions">
                    <h1>Product Catalog</h1>
                    <button class="btn" onclick="openAddForm()">+ Add Product</button>
                </div>

                <div class="card" id="product-form-card" style="display: none;">
                    <h3 id="form-title">Add New Product</h3>
                    <form id="productForm" style="margin-top: 1.5rem;">
                        <input type="hidden" id="edit-id">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display:block; margin-bottom: 5px;">Name</label>
                                <input type="text" id="p-name"
                                    style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"
                                    required>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom: 5px;">Category</label>
                                <select id="p-category"
                                    style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                    <option value="cakes">Signature Cakes</option>
                                    <option value="jarcakes">Jar Cakes</option>
                                    <option value="cupcakes">Cupcakes & Breads</option>
                                    <option value="brownies">Brownies</option>
                                    <option value="cookies">Cookies</option>
                                    <option value="donuts">Donuts</option>
                                    <option value="cheesecakes">Cheesecakes</option>
                                    <option value="dreamcakes">Dream Cakes</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom: 5px;">Price (₹)</label>
                                <input type="number" id="p-price"
                                    style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"
                                    required>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom: 5px;">Unit</label>
                                <input type="text" id="p-unit" placeholder="kg, pc, etc."
                                    style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"
                                    required>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <label style="display:block; margin-bottom: 5px;">Flavors (Comma separated)</label>
                            <input type="text" id="p-flavors" placeholder="e.g. Chocolate, Vanilla, Red Velvet"
                                style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                        </div>
                        <div style="margin-top: 1rem;">
                            <label style="display:block; margin-bottom: 5px;">Description</label>
                            <textarea id="p-desc"
                                style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"
                                rows="3"></textarea>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button type="submit" class="btn">Save Product</button>
                            <button type="button" class="btn" style="background:#757575;"
                                onclick="closeAddForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <div style="margin-bottom: 1.5rem; display: flex; justify-content: flex-end;">
                        <input type="text" id="product-search" class="search-bar" placeholder="Search products..."
                            onkeyup="filterProducts()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-list-body"></tbody>
                    </table>
                </div>
            </section>

            <!-- Tab: Activity Log (Customers) -->
            <section id="tab-customers" class="tab-content">
                <div class="header-actions">
                    <h1>Activity Log</h1>
                </div>
                <div class="card">
                    <div id="activity-log">
                        <!-- JS renders activities here -->
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        import { checkAuth, logout } from './js/auth.js';

        // Auth
        checkAuth();
        window.logoutBtn = logout;

        const STORAGE_KEYS = {
            PRODUCTS: 'gunnuu_products',
            ACTIVITIES: 'gunnuu_user_activities',
            STATS: 'gunnuu_visitor_stats'
        };

        // Tab Switching
        window.switchTab = (tabId, el) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));

            document.getElementById(`tab-${tabId}`).classList.add('active');
            el.classList.add('active');

            if (tabId === 'analytics') loadAnalytics();
            if (tabId === 'products') loadProducts();
            if (tabId === 'customers') loadActivity();
        };

        // --- Products Logic ---
        function loadProducts() {
            const products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS) || '[]');
            const list = document.getElementById('product-list-body');
            list.innerHTML = products.map(p => `
                <tr>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${p.image}" style="width:40px; height:40px; border-radius:6px; object-fit:cover;">
                            <span>${p.name}</span>
                        </div>
                    </td>
                    <td><span class="activity-badge" style="background:#eee; color:#666;">${p.category}</span></td>
                    <td>₹${p.price}</td>
                    <td style="text-align: right;">
                        <button class="btn-sm" style="background:#eee; color:var(--primary); border:none; margin-right:5px; cursor:pointer;" onclick="editProduct(${p.id})">Edit</button>
                        <button class="btn-sm" style="background:#fed; color:red; border:none; cursor:pointer;" onclick="deleteProduct(${p.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        window.openAddForm = () => {
            document.getElementById('product-form-card').style.display = 'block';
            document.getElementById('form-title').innerText = 'Add New Product';
            document.getElementById('productForm').reset();
            document.getElementById('edit-id').value = '';
        };

        window.closeAddForm = () => {
            document.getElementById('product-form-card').style.display = 'none';
        };

        window.editProduct = (id) => {
            const products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS) || '[]');
            const p = products.find(x => x.id === id);
            if (p) {
                openAddForm();
                document.getElementById('form-title').innerText = 'Edit Product';
                document.getElementById('edit-id').value = p.id;
                document.getElementById('p-name').value = p.name;
                document.getElementById('p-category').value = p.category;
                document.getElementById('p-price').value = p.price;
                document.getElementById('p-unit').value = p.unit;
                document.getElementById('p-desc').value = p.desc;
                document.getElementById('p-flavors').value = p.flavors ? p.flavors.join(', ') : '';
            }
        };

        document.getElementById('productForm').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            let products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS) || '[]');

            const flavorInput = document.getElementById('p-flavors').value;
            const flavorsArray = flavorInput ? flavorInput.split(',').map(f => f.trim()).filter(f => f !== '') : [];

            const pData = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('p-name').value,
                category: document.getElementById('p-category').value,
                price: parseInt(document.getElementById('p-price').value),
                unit: document.getElementById('p-unit').value,
                desc: document.getElementById('p-desc').value,
                flavors: flavorsArray,
                image: 'images/chocolate-truffle-cake.jpg' // Default Placeholder for now
            };

            if (id) {
                products = products.map(x => x.id === parseInt(id) ? { ...x, ...pData } : x);
            } else {
                products.push(pData);
            }

            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            closeAddForm();
            loadProducts();
        };

        window.deleteProduct = (id) => {
            if (confirm('Delete this product?')) {
                let products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS) || '[]');
                products = products.filter(x => x.id !== id);
                localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
                loadProducts();
            }
        };

        window.filterProducts = () => {
            const term = document.getElementById('product-search').value.toLowerCase();
            const rows = document.querySelectorAll('#product-list-body tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        };

        // --- Analytics & Customers Logic ---
        function loadAnalytics() {
            const stats = JSON.parse(localStorage.getItem(STORAGE_KEYS.STATS) || '{"visits": 0}');
            const activities = JSON.parse(localStorage.getItem(STORAGE_KEYS.ACTIVITIES) || '[]');
            const products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS) || '[]');

            const leads = activities.filter(a => a.type === 'checkout_start').length;

            document.getElementById('stat-visits').innerText = stats.visits;
            document.getElementById('stat-leads').innerText = leads;
            document.getElementById('stat-products').innerText = products.length;

            const summary = document.getElementById('analytics-summary');
            if (activities.length === 0) {
                summary.innerHTML = '<p>No data recorded yet. Visit the website to generate stats.</p>';
            } else {
                const last5 = activities.slice(0, 5);
                summary.innerHTML = `
                    <p style="margin-bottom: 1rem;"><strong>Engagement Overview:</strong> Your users are mostly adding items to cart recently.</p>
                    <div style="display:flex; gap:1rem;">
                        <div style="flex:1; background:#f9f9f9; padding:1rem; border-radius:8px;">
                            <h5>Recent Add to Cart</h5>
                            <div style="font-size:1.5rem; font-weight:bold; color:var(--accent);">${activities.filter(a => a.type === 'cart_add').length}</div>
                        </div>
                        <div style="flex:1; background:#f9f9f9; padding:1rem; border-radius:8px;">
                            <h5>Avg Order Start</h5>
                            <div style="font-size:1.5rem; font-weight:bold; color:var(--primary);">${leads}</div>
                        </div>
                    </div>
                `;
            }
        }

        function loadActivity() {
            const activities = JSON.parse(localStorage.getItem(STORAGE_KEYS.ACTIVITIES) || '[]');
            const list = document.getElementById('activity-log');

            if (activities.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <i class="fas fa-user-clock" style="font-size: 3rem; color: #eee; margin-bottom: 1rem; display: block;"></i>
                        <p style="color: #757575;">No customer activity recorded yet.</p>
                        <p style="font-size: 0.8rem; color: #999;">Visit your website and click 'Order' to see data here.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = activities.map(a => {
                let color = '#757575';
                let icon = 'fa-info-circle';
                let label = a.type.replace('_', ' ');

                if (a.type === 'cart_add') {
                    color = '#FB8C00';
                    icon = 'fa-cart-plus';
                }
                if (a.type === 'checkout_start') {
                    color = '#4CAF50';
                    icon = 'fa-whatsapp';
                    label = 'Order Started (WhatsApp)';
                }
                if (a.type === 'page_visit') {
                    icon = 'fa-eye';
                    label = 'Website Visit';
                }

                const time = new Date(a.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const date = new Date(a.timestamp).toLocaleDateString();

                return `
                    <div class="activity-item">
                        <div class="activity-time">${time}<br><small>${date}</small></div>
                        <div style="flex: 1;">
                            <span class="activity-badge" style="background:${color}22; color:${color}"><i class="fas ${icon}" style="margin-right:5px;"></i> ${label}</span>
                            <div style="margin-top: 5px; font-weight: 500;">
                                ${a.data.name ? `<strong>${a.data.name}</strong>` : ''} 
                                ${a.data.total ? `Order Total: <strong>₹${a.data.total}</strong>` : ''}
                                ${a.type === 'page_visit' ? `Viewed <span style="color:var(--primary)">${a.data.url === '/' ? 'Home Page' : a.data.url}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Init
        loadAnalytics();
    </script>
</body>

</html>